<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Realcall Test Dialer</title>
    <script src="https://unpkg.com/@twilio/voice-sdk@2.10.1/dist/twilio.min.js"></script>
    <style>
        body { font-family: -apple-system, sans-serif; max-width: 500px; margin: 50px auto; padding: 20px; background: #f5f5f5; }
        .container { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .status { padding: 12px; border-radius: 8px; margin-bottom: 20px; font-size: 14px; font-weight: bold; }
        .ready { background: #e3f2fd; color: #1976d2; }
        .calling { background: #fff3e0; color: #f57c00; }
        .connected { background: #e8f5e9; color: #388e3c; }
        .error { background: #ffebee; color: #c62828; }
        button { width: 100%; padding: 16px; font-size: 18px; border: none; border-radius: 8px; cursor: pointer; transition: 0.3s; margin-top: 10px; }
        #callBtn { background: #4caf50; color: white; }
        #callBtn:disabled { background: #ccc; }
        #hangupBtn { background: #f44336; color: white; display: none; }
        .timer { text-align: center; font-size: 24px; color: #666; margin: 20px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéß Realcall Test Dialer</h1>
        <div id="status" class="status ready">ÂáÜÂ§áÂ∞±Áª™</div>
        <div class="timer" id="timer">00:00</div>
        <button id="callBtn" onclick="initAndCall()">Ëé∑Âèñ Token Âπ∂ÂëºÂè´</button>
        <button id="hangupBtn" onclick="hangup()">ÊåÇÊñ≠</button>
    </div>

    <script>
        const TOKEN_URL = 'https://chi-360dmmc.app.n8n.cloud/webhook/twilio-token';
        const TARGET_NUMBER = '+18444913441';
        
        let device = null;
        let activeCall = null;
        let timerInterval = null;

        async function initAndCall() {
            const statusEl = document.getElementById('status');
            const callBtn = document.getElementById('callBtn');
            
            // 1. È™åËØÅ SDK ÊòØÂê¶Â≠òÂú®
            if (typeof Twilio === 'undefined') {
                alert("Twilio SDK Âä†ËΩΩÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúÊàñÂà∑Êñ∞È°µÈù¢");
                return;
            }

            try {
                statusEl.className = 'status calling';
                statusEl.textContent = 'Ê≠£Âú®Ëé∑Âèñ Token...';
                callBtn.disabled = true;

                // 2. Ëé∑ÂèñÂπ∂Ëß£Êûê Token
                const response = await fetch(TOKEN_URL);
                const rawText = await response.text();
                console.log('n8n ËøîÂõû:', rawText);

                // ‰ΩøÁî®Ê≠£ÂàôÊö¥ÂäõÊèêÂèñÔºåÊó†ËßÜÊï∞ÁªÑÊàñÂµåÂ•ó
                const match = rawText.match(/"token"\s*:\s*"([^"]+)"/);
                const token = match ? match[1] : null;

                if (!token) throw new Error('Êó†Ê≥ïËß£Êûê Token Â≠óÊÆµ');

                statusEl.textContent = 'ÂàùÂßãÂåñËÆæÂ§á‰∏≠...';

                // 3. ÂÖºÂÆπÊÄßÂÆû‰æãÂåñÔºöÈÄöÊùÄ Twilio.Voice.Device Êàñ Twilio.Device
                const DeviceClass = (Twilio.Voice && Twilio.Voice.Device) ? Twilio.Voice.Device : Twilio.Device;
                
                if (!device) {
                    device = new DeviceClass(token, {
                        logLevel: 1,
                        codecPreferences: ['opus', 'pcmu']
                    });
                    
                    // Ê≥®ÂÜå‰∫ã‰ª∂
                    device.on('registered', () => {
                        statusEl.textContent = 'Ê≠£Âú®ÂëºÂè´ AI...';
                        makeCall();
                    });

                    device.on('error', (err) => {
                        console.error('ËÆæÂ§áÈîôËØØ:', err);
                        statusEl.className = 'status error';
                        statusEl.textContent = 'ÈîôËØØ: ' + err.message;
                        resetUI();
                    });
                }

                await device.register();

            } catch (error) {
                console.error('ÊµÅÁ®ã‰∏≠Êñ≠:', error);
                statusEl.className = 'status error';
                statusEl.textContent = error.message;
                resetUI();
            }
        }

        async function makeCall() {
            try {
                const params = { To: TARGET_NUMBER };
                activeCall = await device.connect({ params });

                activeCall.on('accept', () => {
                    document.getElementById('status').className = 'status connected';
                    document.getElementById('status').textContent = 'ÈÄöËØù‰∏≠ - ËØ∑ÂºÄÂßãËØ¥ËØù';
                    document.getElementById('hangupBtn').style.display = 'block';
                    startTimer();
                });

                activeCall.on('disconnect', () => hangup());
                activeCall.on('reject', () => hangup());
            } catch (err) {
                alert("Êã®Âè∑Â§±Ë¥•ÔºåËØ∑Ê£ÄÊü•È∫¶ÂÖãÈ£éÊùÉÈôê");
                resetUI();
            }
        }

        function hangup() {
            if (activeCall) activeCall.disconnect();
            if (device) device.unregister();
            stopTimer();
            resetUI();
        }

        function resetUI() {
            document.getElementById('callBtn').disabled = false;
            document.getElementById('hangupBtn').style.display = 'none';
            document.getElementById('status').className = 'status ready';
            document.getElementById('status').textContent = 'ÂáÜÂ§áÂ∞±Áª™';
            document.getElementById('timer').textContent = '00:00';
        }

        function startTimer() {
            let s = 0;
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                s++;
                const m = String(Math.floor(s / 60)).padStart(2, '0');
                const sec = String(s % 60).padStart(2, '0');
                document.getElementById('timer').textContent = `${m}:${sec}`;
            }, 1000);
        }

        function stopTimer() {
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = null;
        }
    </script>
</body>
</html>